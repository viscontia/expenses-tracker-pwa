#!/bin/bash

# Script per avviare l'app Expenses Tracker PWA
# Posizione: /Users/adrianovisconti/Documents/Sviluppo Software/GitHub/Expenses Tracker PWA/

echo "ðŸš€ Avvio Expenses Tracker PWA..."
echo "=================================="

# Controllo e terminazione processi esistenti
echo "ðŸ” Controllo processi sulla porta 3000..."
PORT_PROCESS=$(lsof -ti:3000)
if [ ! -z "$PORT_PROCESS" ]; then
    echo "âš ï¸  Terminazione processo sulla porta 3000..."
    kill -9 $PORT_PROCESS
    echo "âœ… Processo terminato"
else
    echo "âœ… Nessun processo attivo sulla porta 3000"
fi

echo "ðŸ” Controllo processi vinxi..."
VINXI_PIDS=$(ps aux | grep vinxi | grep -v grep | awk '{print $2}')
if [ ! -z "$VINXI_PIDS" ]; then
    echo "âš ï¸  Terminazione processi vinxi..."
    echo $VINXI_PIDS | xargs kill -9
    echo "âœ… Processi vinxi terminati"
else
    echo "âœ… Nessun processo vinxi attivo"
fi

# Creazione file .env se non esiste
ENV_FILE="Expenses_Tracker/.env"
if [ ! -f "$ENV_FILE" ]; then
    echo "ðŸ”§ Creazione file .env..."
    cat > "$ENV_FILE" << EOF
NODE_ENV=development
ADMIN_PASSWORD=admin123
JWT_SECRET=your-super-secret-jwt-key-here-make-it-long-and-random
DATABASE_URL="postgresql://postgres.bkwkqlbcoltlpttmyrdl:Moscy83Blendy92!!@aws-0-eu-central-1.pooler.supabase.com:5432/postgres?sslmode=require&connect_timeout=5&pool_timeout=5&pool_min_conns=1&pool_max_conns=10&statement_timeout=10s&idle_timeout=30s&application_name=ExpensesTracker"
EOF
    echo "âœ… File .env creato"
fi

echo ""
echo "ðŸ”§ Preparazione ambiente..."

# Caricamento variabili d'ambiente dal file .env
if [ -f "$ENV_FILE" ]; then
    echo "ðŸ“„ Caricamento variabili da .env..."
    export $(cat "$ENV_FILE" | grep -v '^#' | xargs)
    echo "âœ… Variabili d'ambiente caricate"
else
    echo "âš ï¸  File .env non trovato, uso valori di default..."
    export NODE_ENV=development
    export ADMIN_PASSWORD=admin123
    export JWT_SECRET=your-super-secret-jwt-key-here-make-it-long-and-random
    export DATABASE_URL="postgresql://postgres.bkwkqlbcoltlpttmyrdl:Moscy83Blendy92!!@aws-0-eu-central-1.pooler.supabase.com:5432/postgres?sslmode=require&connect_timeout=5&pool_timeout=5&pool_min_conns=1&pool_max_conns=10&statement_timeout=10s&idle_timeout=30s&application_name=ExpensesTracker"
    echo "âœ… Variabili d'ambiente esportate"
fi

echo ""
echo "ðŸš€ Avvio del server di sviluppo..."
echo "ðŸ“± L'app sarÃ  disponibile su: http://localhost:3000"
echo "â¹ï¸  Premi Ctrl+C per fermare il server"
echo ""

# Cambio directory e avvio server
cd Expenses_Tracker

# Eseguo l'aggiornamento dei tassi in background
echo "ðŸ”„ Avvio aggiornamento tassi di cambio in background..."
pnpm run update-rates &

# Avvio il server di sviluppo
pnpm dev 