import{u as ae,c as se,r as l,j as e,a as M,t as k,V as L,L as O,b as te,O as re}from"./index-DRQOx_Xf.js";import{S as le,U as ne,M as ie,a as A,b as R,A as P,C as oe,H as de,L as ce,P as ue,c as me,d as T,e as xe}from"./user-jjiIB_Y9.js";import{X as V}from"./x-DeAad_EH.js";import{D as ge,G as he}from"./trending-up-BLktqF8c.js";import{u as be,M as pe,S as fe,U as ye,T as ve}from"./UnsavedChangesModal-WPjUveF1.js";import{L as je}from"./loader-circle-CIeghaF9.js";import{E}from"./ExchangeRateStatusIndicator-DX_6jn96.js";import{E as ke,e as z}from"./ExchangeRateNotifications-D8l0R8K0.js";import"./createLucideIcon-BKpj3lx_.js";import"./info-DJPN9HXl.js";function Ne(o){return ae({select:i=>i.location})}const we=se(o=>({isOpen:!1,open:()=>o({isOpen:!0}),close:()=>o({isOpen:!1}),toggle:()=>o(i=>({isOpen:!i.isOpen}))}));function D(){const[o,i]=l.useState(null),[t,g]=l.useState(!1),[u,p]=l.useState(!1),[h,c]=l.useState(!1),[y,m]=l.useState(!1);l.useEffect(()=>{const f=window.matchMedia("(display-mode: standalone)").matches,s=window.navigator.standalone===!0;p(f||s);const d=v=>{v.preventDefault(),i(v),g(!0),c(!0)},r=()=>{p(!0),g(!1),i(null),c(!1)};return window.addEventListener("beforeinstallprompt",d),window.addEventListener("appinstalled",r),()=>{window.removeEventListener("beforeinstallprompt",d),window.removeEventListener("appinstalled",r)}},[]);const b=async()=>{if(o)try{await o.prompt(),(await o.userChoice).outcome==="accepted"?console.log("User accepted the install prompt"):console.log("User dismissed the install prompt"),i(null),g(!1),c(!1)}catch(f){console.error("Error during installation:",f)}},x=()=>{m(!0),c(!1)};return!t||u||y||!h?null:e.jsx("div",{className:"fixed bottom-4 right-4 z-50 animate-bounce",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 p-4 max-w-sm",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center",children:e.jsx(le,{className:"h-4 w-4 text-white"})})}),e.jsxs("div",{className:"ml-3",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900 dark:text-white",children:"Installa App"}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-300",children:"Accedi più velocemente e usa l'app offline"})]})]}),e.jsx("button",{onClick:x,className:"flex-shrink-0 ml-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors","aria-label":"Chiudi notifica installazione",children:e.jsx(V,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs("button",{onClick:b,className:"flex-1 inline-flex items-center justify-center px-4 py-2 text-sm font-medium text-white bg-gradient-to-r from-blue-500 to-purple-600 border border-transparent rounded-md hover:from-blue-600 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 transform hover:scale-105","aria-label":"Installa Expense Tracker come app",children:[e.jsx(ge,{className:"h-4 w-4 mr-2"}),"Installa"]}),e.jsx("button",{onClick:x,className:"px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors","aria-label":"Rifiuta installazione",children:"Dopo"})]})]})})}function Ce({isOpen:o,onClose:i}){const{user:t,setTheme:g,updateUserPreferences:u}=M(),[p,h]=l.useState(!1),[c,y]=l.useState(t?.preferences?.theme||"auto"),[m,b]=l.useState(t?.preferences?.defaultCurrency||"EUR"),[x,f]=l.useState(t?.preferences?.chartCategoryCount||10),[s,d]=l.useState(t?.preferences?.currencyOrder||[]),[r,v]=l.useState(""),j=k.auth.updatePreferences.useMutation({onSuccess:()=>{L.success("Impostazioni salvate con successo"),h(!1)},onError:a=>{L.error("Errore nel salvare le impostazioni: "+a.message),h(!1)}});l.useEffect(()=>{o&&t&&(y(t.preferences?.theme||"auto"),b(t.preferences?.defaultCurrency||"EUR"),f(t.preferences?.chartCategoryCount||10),d(t.preferences?.currencyOrder||[]))},[o,t]);const $=[{value:"auto",label:"Auto (Sistema)",icon:ie},{value:"light",label:"Chiaro",icon:A},{value:"dark",label:"Scuro",icon:R}],G=l.useMemo(()=>[{value:5,label:"5 categorie"},{value:10,label:"10 categorie"},{value:15,label:"15 categorie"},{value:20,label:"20 categorie"},{value:25,label:"25 categorie"},{value:999,label:"Tutte le categorie"}],[]),W=a=>{y(a),g(a)},F=a=>{if(a>0){const n=[...s];[n[a-1],n[a]]=[n[a],n[a-1]],d(n)}},B=a=>{if(a<s.length-1){const n=[...s];[n[a],n[a+1]]=[n[a+1],n[a]],d(n)}},K=a=>{s.includes(a)||d([...s,a])},H=a=>{d(s.filter(n=>n!==a))},{data:N}=k.currency.getAvailableCurrencies.useQuery(void 0,{staleTime:1/0,refetchOnMount:!1,refetchOnWindowFocus:!1}),I=l.useMemo(()=>N?.filter(a=>!s.includes(a.code))||[],[N,s]),Q=l.useMemo(()=>({selectedTheme:c,defaultCurrency:m,chartCategoryCount:x,currencyOrder:s,selectedCurrencyToAdd:r}),[c,m,x,s,r]),w=async()=>{h(!0);try{const a={theme:c,defaultCurrency:m,chartCategoryCount:x,currencyOrder:s};await j.mutateAsync(a),u(a)}catch{}},{hasUnsavedChanges:C,resetChanges:X}=be({formData:Q,onSave:w,isSaving:p||j.isPending,disabled:!1,message:"Le tue impostazioni sono state modificate. Vuoi salvarle prima di chiudere?"}),[q,S]=l.useState(!1),J=()=>{C?S(!0):i()},Y=async()=>{try{await w(),X(),S(!1),i()}catch{}},Z=()=>{S(!1),i()},_=()=>{S(!1)};return l.useEffect(()=>{const a=n=>{(n.ctrlKey||n.metaKey)&&n.key==="s"&&(n.preventDefault(),C&&w())};return o&&document.addEventListener("keydown",a),()=>document.removeEventListener("keydown",a)},[C,o]),e.jsxs(e.Fragment,{children:[e.jsx(pe,{isOpen:o,onClose:J,title:"Impostazioni",size:"lg",children:e.jsxs("div",{className:"relative",children:[C&&e.jsx("div",{className:"absolute top-4 right-4 z-10",children:e.jsxs("div",{className:"flex items-center space-x-2 bg-amber-100 dark:bg-amber-900/20 text-amber-800 dark:text-amber-200 px-3 py-1 rounded-full text-xs font-medium border border-amber-200 dark:border-amber-800 shadow-sm",children:[e.jsx("div",{className:"w-2 h-2 bg-amber-500 rounded-full animate-pulse"}),e.jsx("span",{children:"Modifiche non salvate"})]})}),e.jsxs("div",{className:"p-6 space-y-8",children:[e.jsx("div",{className:"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx("div",{className:"flex-shrink-0 w-2 h-2 bg-blue-500 rounded-full mt-2"}),e.jsxs("div",{className:"text-xs text-blue-600 dark:text-blue-400",children:[e.jsx("p",{className:"font-medium mb-1",children:"🛡️ Protezione dati attiva"}),e.jsx("p",{children:"Le tue modifiche sono protette automaticamente. Se tenti di chiudere o navigare con modifiche non salvate, ti verrà chiesto di confermare."}),e.jsxs("p",{className:"mt-1",children:[e.jsx("strong",{children:"Tip:"})," Usa ",e.jsx("kbd",{className:"px-1 py-0.5 bg-blue-200 dark:bg-blue-800 rounded",children:"Ctrl+S"})," (o ",e.jsx("kbd",{className:"px-1 py-0.5 bg-blue-200 dark:bg-blue-800 rounded",children:"Cmd+S"})," su Mac) per salvare rapidamente"]})]})]})}),e.jsxs("div",{className:"border-b border-gray-200 dark:border-gray-700 pb-6",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center",children:[e.jsx(ne,{className:"h-5 w-5 mr-2"}),"Informazioni Account"]}),e.jsx("div",{className:"bg-gray-50 dark:bg-gray-700 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"h-12 w-12 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center",children:e.jsx("span",{className:"text-lg font-medium text-blue-700 dark:text-blue-200",children:t?.email?.charAt(0).toUpperCase()})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 dark:text-white",children:t?.email}),e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:["Membro dal ",t?.createdAt?new Date(t.createdAt).toLocaleDateString("it-IT"):"N/A"]})]})]})})]}),e.jsxs("div",{className:"border-b border-gray-200 dark:border-gray-700 pb-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-4",children:"Tema Interfaccia"}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3",children:$.map(a=>e.jsxs("button",{onClick:()=>W(a.value),className:`flex items-center space-x-3 p-4 rounded-lg border-2 transition-all ${c===a.value?"border-blue-500 bg-blue-50 dark:bg-blue-900/20":"border-gray-200 dark:border-gray-600 hover:border-gray-300 dark:hover:border-gray-500"}`,children:[e.jsx(a.icon,{className:`h-5 w-5 ${c===a.value?"text-blue-600 dark:text-blue-400":"text-gray-500 dark:text-gray-400"}`}),e.jsx("span",{className:`text-sm font-medium ${c===a.value?"text-blue-900 dark:text-blue-100":"text-gray-700 dark:text-gray-300"}`,children:a.label})]},a.value))})]}),e.jsxs("div",{className:"border-b border-gray-200 dark:border-gray-700 pb-6",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center",children:[e.jsx(he,{className:"h-5 w-5 mr-2"}),"Preferenze Valuta"]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Valuta Predefinita"}),e.jsx("select",{value:m,onChange:a=>b(a.target.value),className:"w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:N?.map(a=>e.jsxs("option",{value:a.code,children:[a.symbol||""," ",a.code||""," - ",a.name||""]},a.code))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-4",children:"Gestione Ordine Valute nei Menu"}),I.length>0&&e.jsxs("div",{className:"mb-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800",children:[e.jsx("h4",{className:"text-sm font-medium text-blue-900 dark:text-blue-100 mb-2",children:"Aggiungi Valuta alla Lista Preferita"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("select",{value:r,onChange:a=>v(a.target.value),className:"flex-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"",children:"Seleziona una valuta..."}),I.map(a=>e.jsxs("option",{value:a.code,children:[a.symbol||""," ",a.code||""," - ",a.name||""]},a.code))]}),e.jsx("button",{onClick:()=>{r&&(K(r),v(""))},disabled:!r,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white text-sm font-medium rounded-lg transition-colors",children:"Aggiungi"})]})]}),s.length>0?e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Valute Preferite (Ordine di Visualizzazione)"}),e.jsx("div",{className:"space-y-2",children:s.map((a,n)=>{const U=N?.find(ee=>ee.code===a);return e.jsxs("div",{className:"flex items-center justify-between bg-gray-50 dark:bg-gray-700 rounded-lg p-3",children:[e.jsxs("span",{className:"text-sm text-gray-900 dark:text-white flex-1",children:[U?.symbol||""," ",U?.code||""," - ",U?.name||a]}),e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("button",{onClick:()=>F(n),disabled:n===0,className:"p-1 rounded disabled:opacity-50 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors",title:"Sposta su",children:e.jsx(P,{className:"h-4 w-4 rotate-180"})}),e.jsx("button",{onClick:()=>B(n),disabled:n===s.length-1,className:"p-1 rounded disabled:opacity-50 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors",title:"Sposta giù",children:e.jsx(P,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>H(a),className:"p-1 rounded text-red-600 hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors",title:"Rimuovi dalla lista",children:"✕"})]})]},a)})})]}):e.jsx("div",{className:"text-center py-8 text-gray-500 dark:text-gray-400",children:e.jsxs("p",{className:"text-sm",children:["Nessuna valuta nella lista preferita.",e.jsx("br",{}),"Aggiungi valute per personalizzare l'ordine nei menu."]})})]})]}),e.jsxs("div",{className:"border-b border-gray-200 dark:border-gray-700 pb-6",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center",children:[e.jsx(oe,{className:"h-5 w-5 mr-2"}),"Preferenze Grafici"]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Numero di Categorie nei Grafici"}),e.jsx("select",{value:x,onChange:a=>f(parseInt(a.target.value)),className:"w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:G.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})]})]}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx("button",{onClick:i,className:"bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-6 rounded-lg transition-colors",children:"Annulla"}),e.jsxs("button",{onClick:w,disabled:p||j.isPending,className:"bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium py-2 px-6 rounded-lg transition-colors flex items-center",children:[p||j.isPending?e.jsx(je,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(fe,{className:"h-4 w-4 mr-2"}),"Salva Impostazioni"]})]})]})]})}),e.jsx(ye,{isOpen:q,onSaveAndExit:Y,onExitWithoutSaving:Z,onCancel:_,isSaving:p||j.isPending,message:"Le tue impostazioni sono state modificate. Vuoi salvarle prima di chiudere?"})]})}const Se=[{name:"Dashboard",href:"/dashboard",icon:de,type:"link"},{name:"Elenco Spese",href:"/expenses",icon:ce,type:"link"},{name:"Registra Spese",href:"/expenses/new",icon:ue,type:"link"},{name:"Categorie di Spesa",href:"/categories",icon:ve,type:"link"},{name:"Impostazioni",icon:me,type:"modal"}];function Ue({children:o}){const[i,t]=l.useState(!1),g=Ne(),{user:u,logout:p,setTheme:h}=M(),{isOpen:c,open:y,close:m}=we(),b=u?.preferences?.theme==="dark",x=Se,f=k.useUtils();l.useEffect(()=>{f.currency.getAvailableCurrencies.prefetch()},[f]);const s=()=>{h(b?"light":"dark")},d=()=>{p(),window.location.href="/login"};return e.jsx(ke,{children:e.jsx("div",{className:`min-h-screen ${b?"dark":""}`,children:e.jsxs("div",{className:"bg-white dark:bg-gray-900 transition-colors duration-200",children:[e.jsxs("div",{className:`fixed inset-0 z-50 lg:hidden ${i?"block":"hidden"}`,children:[e.jsx("div",{className:"fixed inset-0 bg-gray-600 bg-opacity-75",onClick:()=>t(!1)}),e.jsxs("div",{className:"fixed inset-y-0 left-0 flex w-64 flex-col bg-blue-50 dark:bg-gray-800",children:[e.jsxs("div",{className:"flex h-16 items-center justify-between px-4",children:[e.jsx("h1",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Expense Tracker"}),e.jsx("button",{onClick:()=>t(!1),className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200","aria-label":"Chiudi menu",children:e.jsx(V,{className:"h-6 w-6"})})]}),e.jsx("nav",{className:"flex-1 px-4 py-4",children:e.jsx("ul",{className:"space-y-2",children:x.map(r=>{const v=r.type==="link"?g.pathname===r.href:!1;return e.jsx("li",{children:r.type==="link"?e.jsxs(O,{to:r.href,className:`flex items-center rounded-lg px-3 py-2 text-sm font-medium transition-colors ${v?"bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-200":"text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700"}`,onClick:()=>t(!1),children:[e.jsx(r.icon,{className:"mr-3 h-5 w-5"}),r.name]}):e.jsxs("button",{onClick:()=>{y(),t(!1)},className:"flex w-full items-center rounded-lg px-3 py-2 text-sm font-medium transition-colors text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700",children:[e.jsx(r.icon,{className:"mr-3 h-5 w-5"}),r.name]})},r.name)})})}),e.jsx("div",{className:"border-t border-gray-200 dark:border-gray-700 p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center min-w-0 flex-1",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center flex-shrink-0",children:e.jsx("span",{className:"text-sm font-medium text-blue-700 dark:text-blue-200",children:u?.email?.charAt(0).toUpperCase()})}),e.jsx("div",{className:"ml-3 min-w-0 flex-1",children:e.jsx("p",{className:"text-sm font-medium text-gray-900 dark:text-white truncate",children:u?.email})})]}),e.jsx("button",{onClick:d,className:"p-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 flex-shrink-0","aria-label":"Logout",children:e.jsx(T,{className:"h-5 w-5"})})]})})]})]}),e.jsx("div",{className:"hidden lg:fixed lg:inset-y-0 lg:flex lg:w-64 lg:flex-col",children:e.jsxs("div",{className:"flex flex-col flex-grow bg-blue-50 dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"flex h-16 items-center justify-between px-4",children:[e.jsx("h1",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Expense Tracker"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(E,{position:"header"}),e.jsx(D,{}),e.jsx("button",{onClick:s,className:"p-2 rounded-lg text-gray-500 hover:text-gray-700 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-gray-200 dark:hover:bg-gray-700","aria-label":b?"Passa al tema chiaro":"Passa al tema scuro",children:b?e.jsx(A,{className:"h-5 w-5"}):e.jsx(R,{className:"h-5 w-5"})})]})]}),e.jsx("nav",{className:"flex-1 px-4 py-4",children:e.jsx("ul",{className:"space-y-2",children:x.map(r=>{const v=r.type==="link"?g.pathname===r.href:!1;return e.jsx("li",{children:r.type==="link"?e.jsxs(O,{to:r.href,className:`flex items-center rounded-lg px-3 py-2 text-sm font-medium transition-colors ${v?"bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-200":"text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700"}`,children:[e.jsx(r.icon,{className:"mr-3 h-5 w-5"}),r.name]}):e.jsxs("button",{onClick:y,className:"flex w-full items-center rounded-lg px-3 py-2 text-sm font-medium transition-colors text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700",children:[e.jsx(r.icon,{className:"mr-3 h-5 w-5"}),r.name]})},r.name)})})}),e.jsx("div",{className:"px-4 py-2",children:e.jsx(E,{position:"sidebar",showDetails:!0})}),e.jsx("div",{className:"border-t border-gray-200 dark:border-gray-700 p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center min-w-0 flex-1",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center flex-shrink-0",children:e.jsx("span",{className:"text-sm font-medium text-blue-700 dark:text-blue-200",children:u?.email?.charAt(0).toUpperCase()})}),e.jsx("div",{className:"ml-3 min-w-0 flex-1",children:e.jsx("p",{className:"text-sm font-medium text-gray-900 dark:text-white truncate",children:u?.email})})]}),e.jsx("button",{onClick:d,className:"p-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 flex-shrink-0","aria-label":"Logout",children:e.jsx(T,{className:"h-5 w-5"})})]})})]})}),e.jsxs("div",{className:"lg:pl-64",children:[e.jsxs("div",{className:"flex h-16 items-center justify-between border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 px-4 lg:hidden",children:[e.jsx("button",{onClick:()=>t(!0),className:"p-2 -ml-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200","aria-label":"Apri menu",children:e.jsx(xe,{className:"h-6 w-6"})}),e.jsx("h1",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Expense Tracker"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(E,{position:"header"}),e.jsx(D,{}),e.jsx("button",{onClick:s,className:"p-2 -mr-2 rounded-lg text-gray-500 hover:text-gray-700 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-gray-200 dark:hover:bg-gray-700","aria-label":b?"Passa al tema chiaro":"Passa al tema scuro",children:b?e.jsx(A,{className:"h-5 w-5"}):e.jsx(R,{className:"h-5 w-5"})})]})]}),e.jsx("main",{className:"flex-1 bg-gray-50 dark:bg-gray-900 min-h-screen",children:e.jsx("div",{className:"py-4 sm:py-6",children:e.jsx("div",{className:"mx-auto max-w-7xl px-4 sm:px-6 lg:px-8",children:o})})})]}),e.jsx(Ce,{isOpen:c,onClose:m})]})})})}function Ee(o={}){const{enabled:i=!0,delayMs:t=2e3,onUpdateStart:g,onUpdateSuccess:u,onUpdateError:p}=o,[h,c]=l.useState({isUpdating:!1,lastUpdateAttempt:null,lastUpdateSuccess:null,error:null}),y=l.useRef(!1),m=l.useRef(null),b=k.currency.invalidateCache.useMutation(),x=k.currency.updateDailyExchangeRates.useMutation({onMutate:()=>{console.log("💱 [ExchangeRateUpdater] Starting background update..."),c(s=>({...s,isUpdating:!0,lastUpdateAttempt:new Date,error:null})),g?.()},onSuccess:s=>{console.log("💱 [ExchangeRateUpdater] Update completed:",s),c(d=>({...d,isUpdating:!1,lastUpdateSuccess:new Date,error:null})),u?.(s),s.skipped?console.log("💱 Exchange rates already updated today - skipped"):s.updatedRates&&s.updatedRates>0&&(console.log(`💱 Exchange rates updated: ${s.updatedRates} rates`),z.success(s.updatedRates),b.mutate({clearAll:!0}),console.log("💾 Cache invalidated after exchange rate update"))},onError:s=>{const d=s.message||"Unknown error";console.error("💱 [ExchangeRateUpdater] Update failed:",d),c(r=>({...r,isUpdating:!1,error:d})),p?.(d),z.error(d)}});return l.useEffect(()=>{if(!i||y.current)return;console.log(`💱 [ExchangeRateUpdater] Scheduling background update in ${t}ms...`),m.current=new AbortController;const s=setTimeout(()=>{if(m.current?.signal.aborted){console.log("💱 [ExchangeRateUpdater] Update cancelled - component unmounted");return}y.current=!0,console.log("💱 [ExchangeRateUpdater] Triggering background update..."),x.mutate()},t);return()=>{clearTimeout(s),m.current&&m.current.abort()}},[i,t,x]),l.useEffect(()=>()=>{m.current&&m.current.abort()},[]),{status:h,forceUpdate:()=>{if(h.isUpdating){console.log("💱 [ExchangeRateUpdater] Update already in progress, skipping force update");return}console.log("💱 [ExchangeRateUpdater] Force update triggered"),x.mutate()},isUpdating:h.isUpdating,hasError:!!h.error,error:h.error}}const Ve=function(){const{isAuthenticated:i,isLoading:t}=M(),g=te();return Ee({enabled:i&&!t,delayMs:3e3,onUpdateSuccess:u=>{u.skipped||console.log(`✅ Exchange rates refreshed: ${u.updatedRates} rates updated`)},onUpdateError:u=>{console.warn("⚠️ Background exchange rate update failed:",u)}}),l.useEffect(()=>{!t&&!i&&g({to:"/login",replace:!0})},[i,t,g]),t?e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-4 text-gray-600 dark:text-gray-400",children:"Verifying authentication..."})]})}):i?e.jsx(Ue,{children:e.jsx(re,{})}):null};export{Ve as component};
